import streamlit as st
import pandas as pd
import plotly.express as px
from streamlit_autorefresh import st_autorefresh

st.title("Dashboard de Detección Facial en Vivo")

LOCKS_FILE = "locks.txt"

# Auto refresco cada 3 segundos
st_autorefresh(interval=3000, key="datarefresh")

# Función para cargar datos desde TXT
def load_data_txt(file_path=LOCKS_FILE):
    data = []
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            for line in f:
                line = line.strip()
                if line:
                    if " - " in line:
                        name_part, datetime_part = line.split(" - ", 1)
                        try:
                            timestamp = pd.to_datetime(datetime_part.strip())
                            data.append({"name": name_part.strip(), "timestamp": timestamp})
                        except Exception as e:
                            st.warning(f"Fecha inválida ignorada: {line}")
                    else:
                        st.warning(f"Línea inválida ignorada: {line}")
    except FileNotFoundError:
        st.warning(f"Archivo no encontrado: {file_path}")
    return pd.DataFrame(data)

# Cargar los datos
df = load_data_txt()

# Mostrar tabla completa
st.subheader("Eventos Registrados")
st.dataframe(df)

# Última detección
if not df.empty:
    last_detection = df['timestamp'].max()
    st.subheader("Última detección")
    st.metric("Última vez detectado", last_detection)

# Detecciones por hora
if not df.empty:
    st.subheader("Detecciones por Hora")
    df['hour'] = df['timestamp'].dt.hour
    hour_counts = df.groupby('hour').size().reset_index(name='count')
    fig_hour = px.bar(hour_counts, x='hour', y='count', labels={'hour':'Hora','count':'Cantidad'})
    st.plotly_chart(fig_hour)

# Detecciones por día
if not df.empty:
    st.subheader("Detecciones por Día")
    df['date'] = df['timestamp'].dt.date
    day_counts = df.groupby('date').size().reset_index(name='count')
    fig_day = px.line(day_counts, x='date', y='count', labels={'date':'Fecha','count':'Cantidad'})
    st.plotly_chart(fig_day)

# Filtro por persona
if not df.empty:
    st.subheader("Filtrar por persona")
    names = df['name'].unique()
    selected_name = st.selectbox("Selecciona la persona", names)
    filtered_by_name = df[df['name'] == selected_name]
    st.dataframe(filtered_by_name)